<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>


<ul id="messages"></ul>

<div>
    <label>
        <input type="text" id="message" placeholder="message">
    </label>
    <button onclick="sendMessage()">
        send message
    </button>
</div>
<br/>
<br/>
<div>
    <label>
        <input type="file" name="" id="file">
    </label>
    <button id="send_file">send file</button>
    <div id="status"></div>
</div>

<script>
    const userId = 2;
    const websocketUrl = `ws://{{ request.headers.host }}/ws/global/${userId}`;
    const fileInput = document.getElementById('file')
    const fileButton = document.getElementById('send_file');
    const statusDiv = document.getElementById('status');


    const ws = new WebSocket(websocketUrl)

    const messagesList = document.getElementById('messages');
    ws.onopen = () => {
        statusDiv.innerHTML = "Connected to WebSocket server.";
    };

    // Событие при получении сообщения от сервера
    ws.onmessage = (event) => {
        statusDiv.innerHTML = `Server response: ${event.data}`;
    };

    // Событие при ошибке соединения
    ws.onerror = (error) => {
        statusDiv.innerHTML = `WebSocket error: ${error.message}`;
    };

    // Событие при закрытии соединения
    ws.onclose = () => {
        statusDiv.innerHTML = "Disconnected from WebSocket server.";
    };
    fileButton.addEventListener('click', () => {
        const file = fileInput.files[0];

        if (!file) {
            statusDiv.innerHTML = "Please select a file to upload.";
            return;
        }

        // Чтение файла в ArrayBuffer для отправки по WebSocket
        const reader = new FileReader();
        reader.onload = function (event) {
            const fileData = event.target.result;
            ws.send(fileData); // Отправляем данные файла на сервер
            statusDiv.innerHTML = `Uploading file: ${file.name}`;
        };
        reader.readAsArrayBuffer(file);
    });
    /*
    ws.onmessage = (event) => {
        messagesList.innerHTML += `
            <li>${event.data}</li>
        `
    }

    fetch(`http://{{ request.headers.host }}/api/v1/chat/global`)
        .then(response => {
            return response.json()
        })
        .then(data => {
            for (let item of data) {
                messagesList.innerHTML += `
                    <li>${item.content}</li>
                `
            }
        })

    function sendMessage() {
        const message = document.getElementById("message").value;
        const item = {
            sender_id: userId,
            content: message
        }

        ws.send(JSON.stringify(item))
        message.value = '';
    }
    */
</script>
</body>
</html>